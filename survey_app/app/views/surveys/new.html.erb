<%= javascript_include_tag 'new.js.erb' %> 

<script>
$(document).ready(function() {
	console.log("New.js.erb -- trying stuff out");

	var answer_json = [];

	var stuff = $('.questions_class').data('questions');
	var questions = JSON.parse(stuff)
	console.log(questions);

	function recurse(obj) {
		$.each(obj, function (key, value) {
			if (value.hasOwnProperty('choices')) {

				var intId = $(".form_div div").length + 1 + key;
				var new_wrapper = $('<div class= wrapper, id = ' + intId + '/>');

				$(".form_div div").append(new_wrapper); // create new wrapper of

				var show_question = value['question'];

				new_wrapper.append(show_question);

				var selections = (value['choices']);
				var show_choice = [];
				var choices = $.each(selections, function(k, v) {
					show_choice.push(v['choice']);
				
				});

				new_wrapper.append(" Your choices are: " + show_choice)

				var additional_answer_input = $('<input type=text, id= answer' + intId + '>');
				new_wrapper.append(additional_answer_input)

				var answer = $('#answer' + intId);
				answer.on("change", function() {
					if ($.inArray(answer.val(), show_choice) != -1) { // if answer in choices
						answer_json.push({
						q: show_question, 
						a: answer.val()
						});
						$.each(value['choices'],  function(k, v) {
							if (answer.val() == v['choice'] & v.hasOwnProperty('follow-ups')) {
								recurse(v['follow-ups']);
							}
						});
					}
					else { 
						alert("Please choose one of the provided options.");
					}
			//		console.log(answer.val());

//					console.log(answer_json)
//					console.log(JSON.stringify(answer_json))
					$("#answer_form").val(JSON.stringify(answer_json));
				});
//				console.log(obj, key, value)
			}
			else { 

				var intId = $(".form_div div").length + 1 + key;
				var new_wrapper = $('<div class= wrapper, id = ' + intId + '/>');

				$(".form_div div").append(new_wrapper); // create new wrapper of

				var show_question = value['question'];

				new_wrapper.append(show_question);
				var additional_answer_input = $('<input type=text, id= answer' + intId + '>');
				new_wrapper.append(additional_answer_input)

				var answer = $('#answer' + intId);
				answer.on("change", function() {
			//		console.log(answer.val());
					answer_json.push({
						q: show_question, 
						a: answer.val()
					});
					console.log(answer_json)
					console.log(JSON.stringify(answer_json))
					$("#answer_form").val(JSON.stringify(answer_json));
				});

			}
		});
	}

	recurse(questions); 

	// if user tries submitting an empty survey
	var submit_button = $('#submit_button');
	submit_button.on("click", function() {
		if ($('#answer_form').val() == 0) {
			alert("You must fill in the form.");
			return false;
		}
	});

});
</script> 

<h1> Questions </h1> 
<%= content_tag :div, class: "questions_class", data: {questions: @data} do %>
<% end %>

<%= form_for @survey do |f| %>

	<div class ="form_div">
		<div class="wrapper">
		</div>
	</div>

	<%= f.hidden_field :kind_id, :value => :kind %> <!-- 0 by default --> 
		<%= f.hidden_field :questions, :value => @data %>
		<%= f.hidden_field :answers, :id => "answer_form" %>
		<%= f.submit "Submit the survey", :id => "submit_button" %>
<% end %>